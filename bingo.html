<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì˜¨ë¼ì¸ í•œê¸€ ë¹™ê³ </title>
  <style>
    :root{
      --sky:#e6f4ff; /* í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
      --ink:#0b1f33;
      --muted:#5b6b7a;
      --card:#ffffff;
      --accent:#1976d2;
      --accent-weak:#e3f2fd;
      --win:#25a244;
      --grid:#d0e3f7;
      --shadow:0 8px 24px rgba(20,60,120,.08);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: "Pretendard", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      color:var(--ink); background:linear-gradient(180deg, var(--sky), #f7fbff);
    }
    .wrap{max-width:1100px; margin:24px auto; padding:16px;}
    .app{display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:start;}
    @media (max-width: 960px){ .app{grid-template-columns: 1fr;} }

    .card{background:var(--card); border-radius:18px; box-shadow:var(--shadow);
      padding:18px 18px 14px; border:1px solid #e9f1fb;}
    h1{margin:0 0 8px; font-size:1.5rem; letter-spacing:-0.2px}
    .sub{margin:0 0 12px; color:var(--muted); font-size:.95rem}

    label{font-weight:600; font-size:.95rem}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:8px 0 10px}
    .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin:8px 0 10px}
    .field{display:flex; flex-direction:column; gap:6px}
    select, input[type="text"], textarea{border:1px solid #cfe3f9; border-radius:12px; padding:10px 12px; font-size:14px; outline:none; background:#fbfdff}
    textarea{min-height:180px; resize:vertical}
    .hint{color:var(--muted); font-size:.86rem}

    .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    button{
      border:1px solid #cfe3f9; background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    button.primary{background:var(--accent); color:white; border-color:var(--accent)}
    button.ghost{background:#f5faff}

    .board{display:grid; gap:8px;}
    .grid{display:grid; gap:8px;}
    .cell{
      background:white; border:2px solid var(--grid); border-radius:14px; min-height:76px; display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; font-size:1.05rem; font-weight:700;
      user-select:none; transition:transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .cell:hover{transform:translateY(-1px)}
    .cell.marked{background:var(--accent-weak); border-color:var(--accent)}
    .cell.free{background:#fffbe6; border-color:#ffe58f}
    .cell.win{outline:3px solid var(--win);}

    .status{margin-top:10px; display:flex; align-items:center; gap:10px}
    .badge{background:#eef6ff; color:#195db3; padding:6px 10px; border-radius:999px; font-weight:800}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}

    .footer{margin-top:10px; color:var(--muted); font-size:.85rem}
    .note{background:#f7fbff; border:1px dashed #cfe3f9; padding:10px 12px; border-radius:12px; margin-top:8px}
    .small{font-size:.85rem}
    .right{margin-left:auto}

    /* --- Celebration Modal --- */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(11,31,51,.35);
      display:none; align-items:center; justify-content:center; padding:24px; z-index:1000;
      backdrop-filter:saturate(120%) blur(2px);
    }
    .modal-backdrop.show{display:flex; animation:fadeIn .18s ease-out}
    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
    .modal{
      background:var(--card); border:1px solid #e9f1fb; border-radius:22px; box-shadow:0 18px 60px rgba(20,60,120,.22);
      max-width:520px; width:100%; padding:26px 22px; text-align:center;
    }
    .modal h2{
      margin:0 0 6px; font-size:1.6rem; letter-spacing:-.3px;
      color:#0b1f33;
    }
    .modal p{margin:0 0 14px; color:var(--muted)}
    .ribbon{
      display:inline-flex; align-items:center; gap:10px;
      background:linear-gradient(120deg, #e3f2fd, #f0f7ff);
      border:1px solid #cfe3f9; border-radius:999px; padding:8px 14px; font-weight:800; color:#195db3;
      margin-bottom:14px;
    }
    .modal .btn-row{display:flex; gap:10px; justify-content:center; margin-top:6px}
    .modal .btn-row button{min-width:120px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:12px">
      <h1>ì˜¨ë¼ì¸ í•œê¸€ ë¹™ê³ </h1>
      <!-- ìš”ì²­ì— ë”°ë¼ ìƒë‹¨ ì„¤ëª… ë¬¸êµ¬ ì œê±° -->
    </div>

    <div class="app">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="row">
          <div class="field">
            <label for="size">ê²©ì í¬ê¸°</label>
            <select id="size">
              <option value="3">3 Ã— 3 (9ì¹¸)</option>
              <option value="4">4 Ã— 4 (16ì¹¸)</option>
              <option value="5" selected>5 Ã— 5 (25ì¹¸)</option>
            </select>
          </div>
          <div class="field">
            <label for="free">ê°€ìš´ë° í”„ë¦¬ ìŠ¤í˜ì´ìŠ¤</label>
            <select id="free">
              <option value="off" selected>ì‚¬ìš© ì•ˆ í•¨</option>
              <option value="on">ì‚¬ìš©</option>
            </select>
            <span class="hint">í™€ìˆ˜ í¬ê¸°(3,5)ì—ì„œ ì¶”ì²œ</span>
          </div>
        </div>

        <div class="field">
          <label for="words">ë‹¨ì–´ ëª©ë¡ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
          <textarea id="words" placeholder="ì˜ˆ) ì§€êµ¬, íƒœì–‘, ë‹¬, ë³„, í–‰ì„±\në¹›\nì¤‘ë ¥\nê³µì „\nìì „\nâ€¦"></textarea>
          <div class="hint">ì„ íƒí•œ ì¹¸ ìˆ˜ ì´ìƒ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì¤‘ë³µì€ ìë™ ì œê±°ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="btns">
          <button class="primary" id="btn-generate">ë¹™ê³  ë§Œë“¤ê¸°</button>
          <button id="btn-shuffle" title="ê°™ì€ ë‹¨ì–´ë¡œ ë°°ì¹˜ë§Œ ë‹¤ì‹œ ì„ê¸°">ë‹¤ì‹œ ì„ê¸°</button>
          <button class="ghost" id="btn-clear">ì´ˆê¸°í™”</button>
          <button class="ghost" id="btn-print">ì¸ì‡„</button>
          <button class="ghost" id="btn-share">ê³µìœ  ë§í¬ ë³µì‚¬</button>
          <span class="muted small" id="save-status"></span>
        </div>

        <div class="note small">
          ğŸ’¡ íŒ: ë‹¨ì–´ë¥¼ ì…ë ¥í•œ ë’¤ <b>ë¹™ê³  ë§Œë“¤ê¸°</b>ë¥¼ ëˆ„ë¥´ë©´ ì¹´ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤. ë™ì¼ ë‹¨ì–´ë¡œ ë°°ì¹˜ë§Œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ <b>ë‹¤ì‹œ ì„ê¸°</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”.
        </div>
      </div>

      <!-- RIGHT: Board -->
      <div class="card">
        <div id="board" class="board">
          <div class="muted">ì•„ì§ ë¹™ê³ íŒì´ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ê³  <b>ë¹™ê³  ë§Œë“¤ê¸°</b>ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
        </div>
        <div class="status" id="status" style="display:none">
          <span class="badge" id="bingo-count">ë¹™ê³  0ì¤„</span>
          <span class="muted">ì¹¸ì„ í´ë¦­í•˜ì—¬ ì²´í¬í•˜ì„¸ìš”. ê°€ë¡œÂ·ì„¸ë¡œÂ·ëŒ€ê°ì„ ì„ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.</span>
        </div>
        <div class="footer">
          ì €ì¥: ì´ ë¸Œë¼ìš°ì €ì—ë§Œ <code>localStorage</code>ë¡œ ë‹¨ì–´ ëª©ë¡ê³¼ ì„¤ì •ì´ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- Celebration Modal -->
  <div class="modal-backdrop" id="win-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="win-title">
      <div class="ribbon">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</div>
      <h2 id="win-title">ë¹™ê³  ì™„ì„±~!</h2>
      <p id="win-desc">ê°€ë¡œ/ì„¸ë¡œ/ëŒ€ê°ì„  2ì¤„ ì´ìƒ ë‹¬ì„±í–ˆì–´ìš”.</p>
      <div class="btn-row">
        <button class="primary" id="btn-continue">ë‹¤ì‹œí•˜ê¸°</button>
        <button class="ghost" id="btn-print2">ì¸ì‡„</button>
      </div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
    const sampleShuffle = (arr) => {
      const a = arr.slice();
      for (let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };
    const uniq = (arr) => [...new Set(arr.map(s=>s.trim()).filter(Boolean))];

    // --- State ---
    const els = {
      size: qs('#size'),
      free: qs('#free'),
      words: qs('#words'),
      board: qs('#board'),
      status: qs('#status'),
      bingoCount: qs('#bingo-count'),
      saveStatus: qs('#save-status'),
      btnGen: qs('#btn-generate'),
      btnShuf: qs('#btn-shuffle'),
      btnClear: qs('#btn-clear'),
      btnPrint: qs('#btn-print'),
      btnShare: qs('#btn-share'),
      // modal
      backdrop: qs('#win-backdrop'),
      btnContinue: qs('#btn-continue'),
      btnPrint2: qs('#btn-print2'),
    };

    // --- Persistence (localStorage) ---
    const KEY = 'kr-bingo:v1';
    const save = () => {
      const data = { size: els.size.value, free: els.free.value, words: els.words.value };
      localStorage.setItem(KEY, JSON.stringify(data));
      els.saveStatus.textContent = 'ì €ì¥ë¨';
      setTimeout(()=> els.saveStatus.textContent='', 1200);
    };
    const load = () => {
      try{
        const url = new URL(location.href);
        const w = url.searchParams.get('w');
        const s = url.searchParams.get('size');
        const f = url.searchParams.get('free');
        if (w){
          els.words.value = decodeURIComponent(w).replace(/\\|/g, '\\n');
          if (s) els.size.value = String(parseInt(s,10));
          if (f) els.free.value = f === '1' ? 'on' : 'off';
          generate();
          return;
        }
      }catch(e){/* ignore */}
      const raw = localStorage.getItem(KEY);
      if (!raw) return;
      try{
        const data = JSON.parse(raw);
        if (data.size) els.size.value = data.size;
        if (data.free) els.free.value = data.free;
        if (data.words) els.words.value = data.words;
      }catch(e){}
    };

    // --- Bingo Logic ---
    let currentGrid = []; // 2D array of cells {el, marked}
    let N = 5;
    let hasCelebrated = false; // ì¶•í•˜ íŒì—… ë…¸ì¶œ ì—¬ë¶€

    function buildGrid(words){
      N = parseInt(els.size.value,10);
      hasCelebrated = false; // ìƒˆ ë³´ë“œì—ì„œ ì´ˆê¸°í™”
      const freeOn = (els.free.value === 'on') && (N % 2 === 1);
      const need = N*N - (freeOn ? 1 : 0);
      const list = sampleShuffle(words).slice(0, need);

      // Create container
      els.board.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'grid';
      grid.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
      els.board.appendChild(grid);

      currentGrid = [];
      let idx = 0;
      for (let r=0; r<N; r++){
        const row = [];
        for (let c=0; c<N; c++){
          const cell = document.createElement('div');
          cell.className = 'cell';

          // center free
          if (freeOn && r === Math.floor(N/2) && c === Math.floor(N/2)){
            cell.textContent = 'FREE';
            cell.classList.add('free', 'marked');
          } else {
            cell.textContent = list[idx++] || '';
          }

          cell.addEventListener('click', ()=>{
            cell.classList.toggle('marked');
            updateBingo();
          });

          grid.appendChild(cell);
          row.push({el:cell});
        }
        currentGrid.push(row);
      }
      updateBingo();
      els.status.style.display = 'flex';
    }

    function getWinThreshold(){
      // 3x3 -> 2ì¤„, 4x4 -> 3ì¤„, 5x5 -> 5ì¤„
      if (N === 3) return 2;
      if (N === 4) return 3;
      if (N === 5) return 5;
      return Math.max(2, Math.ceil(N)); // fallback
    }

    function updateBingo(){
      // Clear win outlines
      qsa('.cell.win').forEach(c=>c.classList.remove('win'));

      const wins = [];
      const marked = (r,c)=> currentGrid[r]?.[c]?.el.classList.contains('marked');

      // Rows
      for (let r=0;r<N;r++){
        let ok=true; for (let c=0;c<N;c++){ if (!marked(r,c)) { ok=false; break; } }
        if (ok) wins.push({type:'row', i:r});
      }
      // Cols
      for (let c=0;c<N;c++){
        let ok=true; for (let r=0;r<N;r++){ if (!marked(r,c)) { ok=false; break; } }
        if (ok) wins.push({type:'col', i:c});
      }
      // Diagonals
      let ok=true; for (let i=0;i<N;i++){ if (!marked(i,i)) { ok=false; break; } } if (ok) wins.push({type:'diag-main'});
      ok=true; for (let i=0;i<N;i++){ if (!marked(i,N-1-i)) { ok=false; break; } } if (ok) wins.push({type:'diag-anti'});

      // Highlight winning lines
      wins.forEach(w=>{
        if (w.type==='row') for (let c=0;c<N;c++) currentGrid[w.i][c].el.classList.add('win');
        if (w.type==='col') for (let r=0;r<N;r++) currentGrid[r][w.i].el.classList.add('win');
        if (w.type==='diag-main') for (let i=0;i<N;i++) currentGrid[i][i].el.classList.add('win');
        if (w.type==='diag-anti') for (let i=0;i<N;i++) currentGrid[i][N-1-i].el.classList.add('win');
      });

      els.bingoCount.textContent = `ë¹™ê³  ${wins.length}ì¤„`;

      // --- Celebration trigger at dynamic threshold ---
      const need = getWinThreshold();
      if (!hasCelebrated && wins.length >= need){
        hasCelebrated = true;
        // Update modal description dynamically
        try{
          const desc = document.getElementById('win-desc');
          if (desc) desc.textContent = `ê°€ë¡œ/ì„¸ë¡œ/ëŒ€ê°ì„  ${need}ì¤„ ì´ìƒ ë‹¬ì„±í–ˆì–´ìš”.`;
        }catch(e){}
        openModal();
      }
    }

    // --- Actions ---
    function parseWords(){
      const raw = els.words.value || '';
      const arr = raw.replace(/\\r/g,'').split(/\\n|,/);
      return uniq(arr);
    }

    function ensureEnough(words){
      const n = parseInt(els.size.value,10);
      const need = n*n - ((els.free.value==='on' && n%2===1) ? 1 : 0);
      if (words.length < need){
        alert(`ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ ${need}ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        return false;
      }
      return true;
    }

    function generate(){
      const words = parseWords();
      if (!ensureEnough(words)) return;
      save();
      buildGrid(words);
    }

    function shuffle(){
      const words = parseWords();
      if (!ensureEnough(words)) return;
      buildGrid(words);
    }

    function clearAll(){
      if (!confirm('ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      els.words.value = '';
      els.size.value = '5';
      els.free.value = 'off';
      localStorage.removeItem(KEY);
      els.board.innerHTML = '<div class="muted">ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ê³  <b>ë¹™ê³  ë§Œë“¤ê¸°</b>ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>';
      els.status.style.display = 'none';
      hasCelebrated = false;
    }

    function printBoard(){
      window.print();
    }

    function shareLink(){
      const words = parseWords();
      if (words.length === 0){ alert('ë‹¨ì–´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
      const s = els.size.value;
      const f = els.free.value === 'on' ? '1' : '0';
      const url = new URL(location.href.split('?')[0]);
      url.searchParams.set('size', s);
      url.searchParams.set('free', f);
      url.searchParams.set('w', encodeURIComponent(words.join('|')));
      navigator.clipboard.writeText(url.toString()).then(()=>{
        alert('ê³µìœ  ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!');
      }).catch(()=>{
        prompt('ë³µì‚¬í•  ìˆ˜ ì—†ì„ ë•ŒëŠ” ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”:', url.toString());
      });
    }

    // --- Modal controls ---
    function openModal(){
      els.backdrop.classList.add('show');
      els.backdrop.setAttribute('aria-hidden','false');
      els.btnContinue?.focus();
    }
    function closeModal(){
      els.backdrop.classList.remove('show');
      els.backdrop.setAttribute('aria-hidden','true');
    }
    function resetGame(){
      // Unmark all cells, but keep FREE cells marked
      const cells = document.querySelectorAll('.cell');
      cells.forEach(cell => {
        cell.classList.remove('win');
        if (cell.classList.contains('free')){
          cell.classList.add('marked');
        } else {
          cell.classList.remove('marked');
        }
      });
      hasCelebrated = false;
      updateBingo();
      closeModal();
    }

    els.btnContinue.addEventListener('click', resetGame);
    els.btnPrint2.addEventListener('click', ()=>{ window.print(); closeModal(); });
    els.backdrop.addEventListener('click', (e)=>{
      if (e.target === els.backdrop) closeModal();
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') closeModal();
    });

    // --- Events ---
    els.btnGen.addEventListener('click', generate);
    els.btnShuf.addEventListener('click', shuffle);
    els.btnClear.addEventListener('click', clearAll);
    els.btnPrint.addEventListener('click', printBoard);
    els.btnShare.addEventListener('click', shareLink);
    els.size.addEventListener('change', save);
    els.free.addEventListener('change', save);
    els.words.addEventListener('input', ()=>{ // autosave but debounce lightly
      if (window.__sv) clearTimeout(window.__sv);
      window.__sv = setTimeout(save, 300);
    });

    // --- Init ---
    load();
  </script>
</body>
</html>
